<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.7">
<title>OpenWrt and Devolo dLAN USB Extender building, flashing and configuration instructions.</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>OpenWrt and Devolo dLAN USB Extender building, flashing and configuration instructions.</h1>
<span id="author">Florian Fainelli</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:florian@openwrt.org">florian@openwrt.org</a>&gt;</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">Nov. 2012</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This document describes the various steps involved in building
flashing and configuring an OpenWrt firmware for the Devolo
dLAN USB Extender device. This device is using a Moschip MCS8140
System-on-a-chip, which is only supported for the moment by the
OpenWrt development version (called trunk later in this document).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="X1">1) Building OpenWrt</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_1_prerequisites">1.1) Prerequisites</h3>
<div class="paragraph"><p>In order to build OpenWrt, we recommend using a Linux-based machine with
the usual GNU software development tools such as GCC, Make, ncurses etc..
Use your Linux distribution package manager to install these tools. If
there is any missing tool, OpenWrt will check for it and warn if it find
it missing or ineadequate.</p></div>
<div class="paragraph"><p>To download the OpenWrt sources the subversion and git tools are required.</p></div>
<div class="paragraph"><p><strong>Note:</strong> OpenWrt can also be built under FreeBSD or MacOSX, but their are not
officially supported as build platforms.</p></div>
</div>
<div class="sect2">
<h3 id="_1_2_checking_out_openwrt_sources">1.2) Checking out OpenWrt sources</h3>
<div class="paragraph"><p>The OpenWrt sources are made available using subversion. Complete
instructions can be found here: <a href="https://dev.openwrt.org/wiki/GetSource">https://dev.openwrt.org/wiki/GetSource</a></p></div>
<div class="paragraph"><p>You should start defining a directory which will serve as the root directory
for the OpenWrt sources and build system.</p></div>
<div class="paragraph"><p>OpenWrt does not require being built as root, and will actually prevent you
from building it as root. Assuming you are in your home directory ($HOME),
create a directory in which you will download OpenWrt sources:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ cd $HOME
$ mkdir -p projects/openwrt
$ cd projects/openwrt</pre>
</div></div>
<div class="paragraph"><p>We can now start downloading the OpenWrt sources in this current directory
by doing the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ svn co svn://svn.openwrt.org/openwrt/trunk/</pre>
</div></div>
<div class="paragraph"><p>The sources are now checked out, and are ready for building.</p></div>
</div>
<div class="sect2">
<h3 id="_1_3_adding_third_party_software_for_powerline_communication">1.3) Adding Third party software for PowerLine Communication</h3>
<div class="paragraph"><p>Prior to building OpenWrt we need to download third-party software, which
is responsible for making the Power Line Communication (PLC) part of the
Devolo dLAN USB Extender device working.</p></div>
<div class="paragraph"><p>The Power Line Communication part of the dLAN USB Extender device requires
some proprietary software which is made available using an OpenWrt "feed".</p></div>
<div class="paragraph"><p>A feed should be seen as a repository in which packages maintained by third
parties can be added.</p></div>
<div class="paragraph"><p>Move to the previously downloaded OpenWrt sources at step 1.2) using the
following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ cd trunk/</pre>
</div></div>
<div class="paragraph"><p>At the root of this directory, edit the file feeds.conf.default, which is
going to contain the download method, name and url of the feed. Alternatively
you can use the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ echo "src-git dlan https://github.com/ffainelli/dlan-usb-extender-3rd-party.git"
  &gt;&gt; feeds.conf.default</pre>
</div></div>
<div class="paragraph"><p>The first column tells the feeds script how to download (using git), the second
is a name to reference to this "feed" and the third one is the url where to find
the package makefiles.</p></div>
<div class="paragraph"><p>Once this is done, we need to get a copy of this feed, in order to do so, use
the following command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ ./scripts/feeds update dlan</pre>
</div></div>
<div class="paragraph"><p>Now that we have got a copy of the feed, we can add the packages to the build
system:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ ./scripts/feeds install foot</pre>
</div></div>
<div class="paragraph"><p>Since foot depends on confmgr and hpav-firmware to run, these packages are
listed as dependencies and the feeds script handles that for us.</p></div>
<div class="paragraph"><p>foot also depends on another package called <span class="monospaced">hpavcfg</span> which is available in a
different feed which is the default repository for OpenWrt packages. To install
this package we need to proceed with the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ ./scripts/feeds update packages
$ ./scripts/feeds install hpavcfg</pre>
</div></div>
<div class="paragraph"><p>The build system will have integrated these packages just like regular packages.</p></div>
</div>
<div class="sect2">
<h3 id="_1_4_building_openwrt">1.4) Building OpenWrt</h3>
<div class="paragraph"><p>Prior to building OpenWrt, we need to instruct the build system about which
target we want to build for. In order to that, remain in the same directory
($HOME/projects/openwrt/trunk) and run the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ make menuconfig</pre>
</div></div>
<div class="paragraph"><p>You will be prompted with a console-based menu with which we will interact for
configuring OpenWrt propertly.</p></div>
<div class="paragraph"><p>In the Target System menu, choose "Moschip MCS814x" and press enter. The OpenWrt
build system has already preconfigured a certain number of base packages, but
still we need to tell the build system to also include the dLAN USB Extender
specific package set.</p></div>
<div class="paragraph"><p>In order to do that, go to the "Target Profile" menu, and switch from "Generic"
to "Devolo dLAN USB Extender", this will now select the "foot" package which is
required for proper Power Line Communication operation.
To select the "hpavcfg" package, now go to the "Network" section and type "y"
as well.</p></div>
<div class="paragraph"><p>Exit and save the configuration.</p></div>
<div class="paragraph"><p>We are now ready to build the entire firmware image, to do so, just run:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ make</pre>
</div></div>
<div class="paragraph"><p>The build usually takes some time (up to one hour on a relatively recent
build machine) due to the building of the toolchain, packages and kernel.</p></div>
<div class="paragraph"><p>Once the build is done, we will have built the base firmware, which contains
the Linux kernel, and all the selected packages.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_flashing_the_device_with_an_openwrt_firmware">2) Flashing the device with an OpenWrt firmware</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now that we have successfully completed the OpenWrt build for the Devolo dLAN
USB Extender device, we can prepare an USB flash stick to flash our device
with this OpenWrt firmware.</p></div>
<div class="sect2">
<h3 id="_2_1_locating_and_preparing_the_openwrt_firmware_image">2.1) Locating and preparing the OpenWrt firmware image</h3>
<div class="paragraph"><p>Remain in the same directory ($HOME/projects/openwrt/trunk), once the build is
finished you will find several files in the directory <span class="monospaced">bin/mcs814x/</span> relative
to this directory which correspond to various files useful for flashing the
target.</p></div>
<div class="paragraph"><p>OpenWrt produces an image which can be used by the dLAN USB Extender firmware
with the USB autoupdate feature. This image is:</p></div>
<div class="paragraph"><p><span class="monospaced">bin/mcs814x/openwrt-mcs814x-dlan-usb-extender-upgrade-squashfs.bin</span></p></div>
<div class="paragraph"><p>You will need to prepare an USB Stick with specific parameters in order to use
the USB autoupdate feature of the dLAN USB Extender. The specific parameters of
this USB stick are:</p></div>
<div class="paragraph"><p>an unique FAT32 partition with the label autoupdate. You should then copy the
file <span class="monospaced">bin/mcs814x/openwrt-mcs814x-dlan-usb-extender-upgrade-squashfs.bin</span> to
this USB stick and name the file autoupdate_image. You can for instance use the
following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ cp bin/mcs814x/openwrt-mcs814x-dlan-usb-extender-upgrade-squashfs.bin
     /media/AUTOUPDATE/autoupdate_image</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_2_2_flashing_the_dlan_usb_extender">2.2) Flashing the dLAN USB Extender</h3>
<div class="paragraph"><p>Your device is now ready to be flashed with this OpenWrt firmware, in order to
let the autoupdate feature start, just plug in the USB key, and power cycle
your device.</p></div>
<div class="paragraph"><p>The USB LED will start blinking fast indicating that it is reading the firmware
file from the USB stick.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_configuring_your_openwrt_device">3) Configuring your OpenWrt device</h2>
<div class="sectionbody">
<div class="paragraph"><p>By default the device will come up on the Power Line Communication network with
the following parameters:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Ethernet MAC address: 00:0B:3B:00:00:01
IP address: 192.168.1.1
Netmask: 255.255.255.0
Homeplug AV NPW: HomePlugAV
Telnet access with no password</pre>
</div></div>
<div class="sect2">
<h3 id="_3_1_configuring_ip_networking">3.1) Configuring IP networking</h3>
<div class="paragraph"><p>For all OpenWrt devices IP networking is configured using the file
<span class="monospaced">/etc/config/network</span> and contains the following:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>config interface lan
        option ifname   eth0
        option proto    static
        option ipaddr   192.168.1.1
        option netmask  255.255.255.0</pre>
</div></div>
<div class="paragraph"><p>The Ethernet MAC address of the interface can be changed at any time by using
the configuration option "macaddr", this option should be added to the file
<span class="monospaced">/etc/config/network</span>, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        option macaddr  00:0B:3B:00:00:01</pre>
</div></div>
<div class="paragraph"><p>If you want to configure your device to instead obtain its IP address
via DHCP, just replace the "static" protocol by "dhcp". You should then issue
the following command for the settings to be applied:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ /etc/init.d/network restart</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_3_2_configuring_power_line_communication_networking">3.2) Configuring Power Line Communication networking</h3>
<div class="paragraph"><p>Power Line Communication networking is configured through several means among
them:</p></div>
<div class="ulist"><ul>
<li>
<p>
using the file /etc/config/foot
</p>
</li>
<li>
<p>
using the push button located at the back of the device
</p>
</li>
<li>
<p>
using the hpavcfg utility
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_3_2_1_using_etc_config_foot">3.2.1) Using /etc/config/foot</h4>
<div class="paragraph"><p>The file /etc/config/foot is responsible for configuring the PLC chip with
initial parameters on startup, the most important parameters is the DPW
(Security ID or device password). Once the settings have been
changed, you will need to powercycle the device for the PLC chip to fetch its
new parameters, this can be done using the following command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ /etc/init.d/foot restart</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_3_2_2_using_the_push_button">3.2.2) Using the push button</h4>
<div class="paragraph"><p>To associate your device with an existing Homeplug AV network, you should press
another device push button, then press the push button on the device you want
to associate as well. Both Power LEDS will be blinking, and you should then
see the PLC LEDs start blinking to indicate trafic is properly emitted and
received by devices.</p></div>
</div>
<div class="sect3">
<h4 id="_3_2_3_using_the_hpavcfg_utility">3.2.3) Using the hpavcfg utility</h4>
<div class="paragraph"><p>The hpavcfg utility is a ligthweight configuration utility which is able to send
a NPW to either a local or remote device. To change a device&#8217;s NPW, you should
issue the following command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ hpav_cfg -n &lt;network passphrase&gt; &lt;network interface&gt;</pre>
</div></div>
<div class="paragraph"><p>by default, hpav_cfg will use the HomePlugAV broadcast MAC address for sending
this command. If you want to target a single device, use the "-a" switch of
the utility, as show below:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ hpav_cfg -n &lt;network passphrase&gt; -a 00:11:22:33:44:55 &lt;network interface&gt;</pre>
</div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_using_wmbus_repeater_with_the_dlan_usb_extender">4) Using wmbus-repeater with the dLAN USB Extender</h2>
<div class="sectionbody">
<div class="paragraph"><p>wmbus-repeater is a software package allowing Open Metering System repeater
functionnality between two host devices using a network interface on one side
and an Amber Wireless USB stick (AMB8465 devices) on the other side.</p></div>
<div class="paragraph"><p>OMS wireless data received on the USB stick can be forwarded back to the
network interface and vice versa, OMS data received over the network interface
can be sent to the USB stick and then over the OMS wireless network.</p></div>
<div class="sect2">
<h3 id="_4_1_typical_oms_network_topology_and_functionnality">4.1) Typical OMS network topology and functionnality</h3>
<div class="paragraph"><p>To repeat OMS data, the setup must be comprised of two USB sticks and two dLAN
USB Extender devices at least. The dLAN USB Extender devices must have been
preliminary paired to be connected to each other in the same HomePlug AV
network (see documentation above to pair the dLAN USB Extender devices).</p></div>
<div class="paragraph"><p>The typical setup will look like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>---------------     -----------------      -----------------    --------------
| USB stick 1 | &lt;-&gt; | dLAN USB Ext 1| &lt;==&gt; | dLAN USB Ext 2| &lt;-&gt;| USB Stick 2 |
---------------     -----------------      -----------------    --------------
  T1 meter mode         Same HomePlug AV network                T2 other mode</pre>
</div></div>
<div class="paragraph"><p>See section 4.2 below to see how to configure wmbus-repeater in T1 meter and
T2 other mode.</p></div>
<div class="paragraph"><p>OMS wireless data sent to USB Stick 1, configured as T1 meter mode, will be
sent over the HomePlug AV network interface of dLAN USB Ext 1 and be received
over the HomePlug AV network interface by dLAN USB Ext 2. dLAN USB Ext 2 will
then forward this OMS wireless data to the USB STick 2 attached to it and set
the "hop" counter to 1 (data is repeated).</p></div>
<div class="paragraph"><p>By combining several times this basic network topology you can very easily
create repeated wmBus networks using the HomePlug AV network as a backbone for
repeating wireless data.</p></div>
<div class="paragraph"><p>The wmbus-repeater software is handling the repeated packet in such a way
that:</p></div>
<div class="ulist"><ul>
<li>
<p>
only packets with a hop counter set to 0 will be repeated
</p>
</li>
<li>
<p>
packets with a hop counter different from 0 will not be repeated
</p>
</li>
</ul></div>
<div class="paragraph"><p>This is to ensure that devices too close to each other, typically a T2 other
device close enough to receive data from two T1 meter emitters will not repeat
twice the same data received both over the HomePlug AV interface and over the
USB stick.</p></div>
</div>
<div class="sect2">
<h3 id="_4_2_configuring_wmbus_repeater">4.2) Configuring wmbus-repeater</h3>
<div class="paragraph"><p>The configuration of the wmbus-repeater software is done in
<span class="monospaced">/etc/config/wmbus-repeater</span>. The default configuration is the following:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>config wmbus-repeater
        option device "/dev/ttyUSB0"
        option interface "eth0"
        option mode "S1</pre>
</div></div>
<div class="paragraph"><p>Mode can be:</p></div>
<div class="ulist"><ul>
<li>
<p>
S1
</p>
</li>
<li>
<p>
S2
</p>
</li>
<li>
<p>
T1meter
</p>
</li>
<li>
<p>
T1other
</p>
</li>
<li>
<p>
T2meter
</p>
</li>
<li>
<p>
T2other
</p>
</li>
<li>
<p>
retain
</p>
</li>
</ul></div>
<div class="paragraph"><p>Depending on your setup and Wireless and HomePlug AV network topology, you will
have to configure the wmbus-repeater daemon to be in one of the mode presented
above. The "retain" mode is a special value which is to be used when you do not
want to change the mode pre-configured in the USB stick.</p></div>
</div>
<div class="sect2">
<h3 id="_4_3_starting_stopping_and_usb_stick_hot_plugging">4.3) Starting/stopping and USB stick hot-plugging</h3>
<div class="paragraph"><p>By default, when a USB stick is hotplugged on a dLAN USB Extender device the
wmbus-repeater software will be started on the corresponding <span class="monospaced">/dev/ttyUSB&lt;N&gt;</span>
device with the mode specified in the configuration file
<span class="monospaced">/etc/config/wmbus-repeater</span>. You can still control the execution life of
wmbus-repeater by issuing the following commands:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ /etc/init.d/wmbus-repeater stop
$ /etc/init.d/wmbus-repeater start</pre>
</div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2012-11-22 22:35:46 CET
</div>
</div>
</body>
</html>
